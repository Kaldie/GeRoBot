# put common definitions in here
#######################################################
#################### Folders ##########################

#Directory with header files
INCLUDEFOLDER = include

#Folder with objects
OBJECTFOLDER = bin/objects

#Folder with shared libs
LIBFOLDER = bin/lib

#######################################################
################# Bash Commands #######################

# current directory
CURRENT_DIR = $(shell pwd)
# remove
RM= rm -rf

# create directory
MKDIR_P = mkdir -p

# create symbolic link
LINK = ln -fsv

# test gen
TESTGEN = cxxtestgen

#######################################################
############ Compiling configuration ##################

#Compiler
CC = g++

#Compiler Flags
CFLAGS = -H -Wall -o3 -fno-inline -std=c++11 -fpic -Wfatal-errors

#Compile shared Lib flags
CSHAREDFLAGS = -shared

#Shared lib linking flags
SHAREDLDFLAGS = -Wl,-rpath=$(TOROOT)/$(LIBFOLDER)

#Header files
INCLUDES = -I $(TOROOT)/$(INCLUDEFOLDER)

#Liberary folders
LFLAGS = -L $(TOROOT)/$(LIBFOLDER)

#######################################################
################# Make Targets ########################

#Conversion from source files to object files
OBJS := $(addprefix $(TOROOT)/$(OBJECTFOLDER)/, $(SRCS:.cpp=.o))
DEPENDENCY := $(addprefix $(TOROOT)/$(OBJECTFOLDER)/, $(DEPENDENCY))

#when
unitTest: OBJS := $(foreach obj,$(notdir $(OBJS)),$(TOROOT)/$(OBJECTFOLDER)/$(obj))
DOBJS = $(DSRCS:.cpp=.o)


#Default target, compile all source files
all: $(OBJS)
#	@echo "Compiling all object files for this dir!"
#	@echo $(OBJS)


#Compile debug source and link it to an executable
debug: $(OBJS) $(DOBJS)
	@echo  "Creating executable for debug purposes"
	$(CC) $(CFLAGS) $(INCLUDES) $(LFLAGS) -o $(DEBUG) $(OBJS) $(DEPENDENCY) $(DOBJS) $(LFLAGS) $(SHAREDLDFLAGS) $(LIBS)


#Create a shared lib
shared: $(OBJS) $(DEPENDENCY)
	@echo "creating shared object lib"
	$(CC) $(CFLAGS) $(INCLUDES) -shared -o $(TOROOT)/$(LIBFOLDER)/lib$(MAIN).so $(OBJS) $(DEPENDENCY) $(LFLAGS) $(SHAREDLDFLAGS) $(LIBS)	


#Clean folder of object file, libs and other bits and pieces
clean:
	$(RM) $(OBJS)
	$(RM) $(addprefix $(TOROOT)/$(LIBFOLDER)/,*$(MAIN)*)


#How to convert cpp to o files
$(TOROOT)/$(OBJECTFOLDER)/%.o : %.cpp $(TOROOT)/$(INCLUDEFOLDER)/macroHeader.h.gch
	$(CC) $(CFLAGS) $(INCLUDES) -c $< -o $@


$(TOROOT)/$(INCLUDEFOLDER)/%.h.gch: $(TOROOT)/%.h
	$(CC) $(CFLAGS) $(INCLUDES) -c $< -o $@			
		

unitTest: $(UnitTests) 
	cd ..; make; cd unit_test
	$(TESTGEN) --error-printer -o $@.cpp $(UnitTests)
	$(CC) $(CFLAGS) $(INCLUDES) $(LFLAGS) -o $@ $@.cpp $(OBJS) $(DEPENDENCY) $(LFLAGS) $(SHAREDLDFLAGS) $(LIBS)
	./$@ $(UNIT_TEST)

.PRECIOUS: $(TOROOT)/$(INCLUDEFOLDER)/%.h.gch